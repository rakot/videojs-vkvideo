(function(root,factory){if(typeof exports==="object"&&typeof module!=="undefined"){var videojs=require("video.js");module.exports=factory(videojs.default||videojs)}else if(typeof define==="function"&&define.amd){define(["videojs"],function(videojs){return root.VkVideo=factory(videojs)})}else{root.VkVideo=factory(root.videojs)}})(this,function(videojs){var Tech=videojs.getTech("Tech");var VK_SCRIPT_SRC="https://vk.com/js/api/videoplayer.js";var VK_HOSTS=["vk.com","www.vk.com","vkvideo.ru","www.vkvideo.ru"];function loadVkSdkOnce(){if(window.VK&&window.VK.VideoPlayer){return Promise.resolve()}if(loadVkSdkOnce._p){return loadVkSdkOnce._p}loadVkSdkOnce._p=new Promise((resolve,reject)=>{var s=document.createElement("script");s.src=VK_SCRIPT_SRC;s.async=true;s.onload=()=>{let tries=0;(function waitVK(){if(window.VK&&window.VK.VideoPlayer){return resolve()}if(tries++>50){return reject(new Error("VK.VideoPlayer not available"))}setTimeout(waitVK,50)})()};s.onerror=()=>reject(new Error("Failed to load VK videoplayer.js"));document.head.appendChild(s)});return loadVkSdkOnce._p}function ensureJsApiParam(url){try{var u=new URL(url,window.location.href);if(!u.searchParams.has("js_api")){u.searchParams.set("js_api","1")}return u.toString()}catch(e){return url.indexOf("js_api=1")===-1?url+(url.indexOf("?")===-1?"?js_api=1":"&js_api=1"):url}}function isVkEmbed(url){try{var u=new URL(url,window.location.href);return u.pathname.indexOf("video_ext.php")!==-1&&VK_HOSTS.includes(u.hostname)}catch(e){return/:\/\/(www\.)?(vkvideo\.ru|vk\.com)\/.*video_ext\.php/.test(url)}}function parseTimeFromEvent(ev){if(!ev){return null}return typeof ev.time==="number"?ev.time:typeof ev.currentTime==="number"?ev.currentTime:null}class VkVideoTech extends Tech{constructor(options,ready){super(options,ready);this.el_=this.createEl();this._iframe=null;this._vkPlayer=null;this._isReady=false;this._duration=NaN;this._currentTime=0;this._paused=true;this._muted=false;this._volume=1;this._boundOnMessage=null;this._eventUnsubs=[];this.setTimeout(()=>{this._setup().then(()=>{this.triggerReady()}).catch(err=>{videojs.log.error("[VKTech] init error:",err);this.error({code:4,message:"VK init failed"})})},0)}createEl(){var el=videojs.dom.createEl("div",{className:"vjs-vkvideo tech"});el.style.position="relative";el.style.width="100%";el.style.height="100%";return el}dispose(){if(this._eventUnsubs){this._eventUnsubs.forEach(fn=>{try{if(fn){fn()}}catch(e){}});this._eventUnsubs=[]}if(this._boundOnMessage){window.removeEventListener("message",this._boundOnMessage);this._boundOnMessage=null}if(this._vkPlayer&&typeof this._vkPlayer.destroy==="function"){try{this._vkPlayer.destroy()}catch(e){}}this._vkPlayer=null;super.dispose()}parseUrl(url){var result={id:null,ownerId:null};var regex=/^https?:\/\/(vk.com|vkvideo.ru)\/.*video(-?[0-9]+_[0-9]+)/;var match=url.match(regex);if(match&&match[2].length>10){[result.ownerId,result.id]=match[2].split("_")}return result}async _setup(){var source=this.options_.source||{};let src=source.src||"";if(!src){throw new Error("No source for VK tech")}if(!isVkEmbed(src)){var parsedSrc=this.parseUrl(src);if(parsedSrc.ownerId&&parsedSrc.id){var base="https://vk.com/video_ext.php";var params=new URLSearchParams({oid:String(parsedSrc.ownerId),id:String(parsedSrc.id),hd:String(source.hd||0),hash:source.hash||""});src=base+"?"+params.toString()}}src=ensureJsApiParam(src);var iframe=document.createElement("iframe");iframe.setAttribute("allow","autoplay; encrypted-media; fullscreen; picture-in-picture; screen-wake-lock");iframe.setAttribute("frameborder","0");iframe.setAttribute("allowfullscreen","true");iframe.setAttribute("title","VK Video");iframe.style.position="absolute";iframe.style.inset="0";iframe.style.width="100%";iframe.style.height="100%";iframe.src=src;this.el_.appendChild(iframe);this._iframe=iframe;await loadVkSdkOnce();this._vkPlayer=new window.VK.VideoPlayer(iframe);this._wireEvents();this._isReady=true;this.trigger("loadedmetadata");this.trigger("loadstart")}_wireEvents(){var vkPlayer=this._vkPlayer;var tryOn=(eventName,handler)=>{if(vkPlayer&&typeof vkPlayer.on==="function"){vkPlayer.on(eventName,handler);this._eventUnsubs.push(()=>{try{if(vkPlayer.off){vkPlayer.off(eventName,handler)}}catch(e){}});return true}return false};var onPlay=()=>{this._paused=false;this.trigger("playing");this.trigger("play")};var onPause=()=>{this._paused=true;this.trigger("pause")};var onEnded=()=>{this._paused=true;this.trigger("ended")};var onTime=ev=>{var t=parseTimeFromEvent(ev);if(typeof t==="number"){this._currentTime=t;this.trigger("timeupdate")}if(ev&&typeof ev.duration==="number"){this._duration=ev.duration;this.trigger("durationchange")}};var onVolume=ev=>{if(ev&&typeof ev.volume==="number"){this._volume=ev.volume}if(ev&&typeof ev.muted==="boolean"){this._muted=ev.muted}this.trigger("volumechange")};var onReady=()=>{this._isReady=true;this._vkPlayer.play();this.trigger("loadedmetadata")};var onError=ev=>{this.error({code:3,message:"VK player error",event:ev});this.trigger("error")};var wired=tryOn("inited",onReady)|tryOn("started",onPlay)|tryOn("resumed",onPlay)|tryOn("paused",onPause)|tryOn("ended",onEnded)|tryOn("timeupdate",onTime)|tryOn("progress",onTime)|tryOn("volumechange",onVolume)|tryOn("error",onError);if(!wired){this._boundOnMessage=e=>{try{if(!e||!e.data){return}var origin=(e.origin||"").replace(/^https?:\/\//,"");if(!VK_HOSTS.some(h=>origin.endsWith(h))){return}var data=typeof e.data==="string"?JSON.parse(e.data):e.data;if(!data||!data.type){return}switch(data.type){case"ready":onReady();break;case"play":onPlay();break;case"paused":onPause();break;case"ended":onEnded();break;case"timeupdate":onTime(data);break;case"progress":onTime(data);break;case"volumechange":onVolume(data);break;case"error":onError(data);break;default:break}}catch(err){}};window.addEventListener("message",this._boundOnMessage)}}setSrc(src){var url=ensureJsApiParam(src);if(this._iframe){this._iframe.src=url}}play(){if(this._vkPlayer&&typeof this._vkPlayer.play==="function"){try{this._vkPlayer.play()}catch(e){}}this._paused=false;return Promise.resolve()}seeking(){return this.isSeeking}seekable(){if(!this._vkPlayer){return videojs.createTimeRange()}return videojs.createTimeRange(0,this._vkPlayer.getDuration())}onSeeked(){clearInterval(this.checkSeekedInPauseInterval);this.isSeeking=false;if(this.wasPausedBeforeSeek){this.pause()}this.trigger("seeked")}playbackRate(){return 1}pause(){if(this._vkPlayer&&typeof this._vkPlayer.pause==="function"){try{this._vkPlayer.pause()}catch(e){}}this._paused=true}paused(){return this._paused}currentTime(){return this._currentTime||0}setCurrentTime(seconds){if(this._vkPlayer){try{if(typeof this._vkPlayer.seek==="function"){this._vkPlayer.seek(seconds)}else if(typeof this._vkPlayer.seekTo==="function"){this._vkPlayer.seekTo(seconds)}else if(typeof this._vkPlayer.setCurrentTime==="function"){this._vkPlayer.setCurrentTime(seconds)}}catch(e){}}this._currentTime=seconds;this.trigger("timeupdate");return seconds}duration(){return Number.isFinite(this._duration)?this._duration:NaN}ended(){return Number.isFinite(this._duration)&&Math.abs((this._currentTime||0)-this._duration)<.25&&this._paused}volume(){return this._volume}setVolume(v){this._volume=Math.max(0,Math.min(1,v));if(this._vkPlayer){try{if(typeof this._vkPlayer.setVolume==="function"){this._vkPlayer.setVolume(this._volume)}}catch(e){}}this.trigger("volumechange")}muted(){return this._muted}setMuted(m){this._muted=!!m;if(this._vkPlayer){try{if(this._muted&&typeof this._vkPlayer.mute==="function"){this._vkPlayer.mute()}else if(!this._muted&&typeof this._vkPlayer.unmute==="function"){this._vkPlayer.unmute()}}catch(e){}}this.trigger("volumechange")}supportsFullScreen(){return true}setPoster(){}buffered(){return videojs.createTimeRanges()}}VkVideoTech.isSupported=function(){return true};VkVideoTech.canPlayType=function(e){return e==="video/vkvideo"};VkVideoTech.canPlaySource=function(e){return VkVideoTech.canPlayType(e.type)};VkVideoTech.prototype.options_={};if(typeof videojs.registerTech!=="undefined"){videojs.registerTech("VkVideo",VkVideoTech)}else{videojs.registerComponent("VkVideo",VkVideoTech)}});